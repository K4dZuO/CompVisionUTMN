# Как работает отслеживание объектов (Просто о сложном)

Этот документ объясняет, как именно работает наша система отслеживания машин, без сложных формул и лишней воды.

## Архитектура системы

Наша система состоит из **двух независимых модулей**, которые можно комбинировать:

1. **Модуль оптического потока** (Хорн-Шанк или Лукас-Канаде)
2. **Модуль отслеживания объектов** (включается чекбоксом)

Вы можете:
- Использовать **только** оптический поток (для визуализации движения)
- Использовать оптический поток **+ отслеживание** (для идентификации конкретных машин)

---

## 1. Плотный оптический поток (Алгоритм Хорна-Шанка)

**Что это?**
Представьте, что вы смотрите на два последовательных кадра видео. На первом машина стоит в точке А, на втором — чуть сдвинулась в точку Б.

**Как это работает:**
1. Мы используем **собственную реализацию** алгоритма Хорна-Шанка из `core/horn_schunck.py`.
2. Этот алгоритм решает систему уравнений для каждого пикселя, чтобы найти его смещение.
3. В результате мы получаем **поле векторов** (или "штрихов").
   - **Длина штриха** = скорость движения.
   - **Направление штриха** = куда едет объект.

**Зачем это нужно?**
Это дает нам **плотную** картину движения. Мы видим не просто "что-то изменилось", а конкретно "вот эта куча пикселей поехала направо".

**Визуализация:**
- **HSV**: Цветная карта потока (цвет = направление, яркость = скорость)
- **Стрелки**: Векторы на сетке
- **Heat Map**: Тепловая карта интенсивности движения

---

## 2. Разреженный оптический поток (Алгоритм Лукаса-Канаде)

**Отличие от Хорна-Шанка:**
Вместо того чтобы вычислять поток для **каждого** пикселя, Лукас-Канаде находит "интересные" точки (углы, текстуры) и отслеживает только их.

**Как это работает:**
1. Используем `core/lucas_kanade.py`.
2. Находим "хорошие точки для отслеживания" (метод Shi-Tomasi).
3. Для каждой точки вычисляем, куда она переместилась.

**Преимущество:**
Быстрее, чем Хорн-Шанк, но дает меньше информации (только ключевые точки).

---

## 3. Как включается отслеживание объектов

Когда вы ставите галочку **"Включить отслеживание"**, происходит следующее:

### Шаг 1: Создание маски движения

**Для Хорна-Шанка:**
1. Берем величину потока (magnitude) для каждого пикселя.
2. **Нормализация**: Приводим значения к диапазону 0-255 для стабильности.
3. **Адаптивный порог (Otsu)**: Алгоритм автоматически находит оптимальный порог разделения движущихся и статичных пикселей.
   - Это лучше, чем фиксированный порог, потому что адаптируется к разным видео.
4. Результат: бинарная маска (белое = движение, черное = фон).

**Для Лукаса-Канаде:**
- Берем найденные точки (ключевые углы).
- Рисуем вокруг каждой точки кружок (радиус 3 пикселя).
- Расширяем эти кружки (дилатация), чтобы объединить близкие точки в одно пятно.

### Шаг 2: Улучшенная чистка маски

Маска может быть "дырявой" (например, лобовое стекло машины не дает потока) или шумной. Применяем последовательность морфологических операций:

1. **Closing (Закрытие)**: Заполняет дыры внутри белых пятен.
   - Ядро: эллипс 7x7 пикселей
   - Эффект: Машина с прозрачным стеклом становится цельным пятном

2. **Opening (Открытие)**: Убирает мелкий шум (отдельные белые пиксели).
   - Ядро: эллипс 3x3 пикселя
   - Эффект: Убирает ложные срабатывания от листвы, дрожания камеры

3. **Dilation (Расширение)**: Раздувает объекты для лучшего объединения.
   - Ядро: эллипс 5x5 пикселей, 2 итерации
   - Эффект: Близкие части машины (капот, крыша, багажник) объединяются в одно пятно

**Почему это важно:**
- Без морфологии: машина распадается на 3-5 отдельных объектов (капот, крыша, багажник)
- С морфологией: машина = 1 цельный объект

### Шаг 3: Поиск контуров

Компьютер обводит белые пятна на маске прямоугольниками (bounding boxes). 

**Фильтрация:**
- Если площадь прямоугольника < `min_area` → выкидываем (это мусор).
- Типичная машина в видео 1920x1080: 1000-5000 пикселей.

**Итог:** Список прямоугольников (потенциальных машин) на текущем кадре.

---

## 4. Центроидный трекер (Связывание объектов во времени)

На кадре №1 была машина в координатах (100, 100).
На кадре №2 мы нашли машину в координатах (105, 100).
Как понять, что это одна и та же машина?

**Алгоритм:**
1. Берем **центр** (точку посередине) каждого прямоугольника.
2. Смотрим на центры с прошлого кадра и центры на новом кадре.
3. **Евклидово расстояние:** Измеряем расстояние между всеми старыми и новыми центрами.
4. **Принцип ближайшего соседа:**
   - Центр А (старый) ближе всего к Центру Б (новому).
   - Расстояние маленькое (меньше `max_distance`).
   - **Вывод:** Это одна и та же машина! Передаем ей старый ID (например, "Машина №5").

Если для нового центра не нашлось старого "друга" поблизости — значит, это **новая машина**. Присваиваем новый ID.
Если старый центр остался без пары — значит, машина **уехала** из кадра (или временно скрылась).

**Параметр `max_disappeared`:**
Если машина исчезла (например, за грузовиком), мы не удаляем её сразу. Ждем `max_disappeared` кадров. Если за это время она не появилась — удаляем ID.

---

## 5. Визуализация результатов

Когда отслеживание включено, на экране вы видите:

1. **Фон:** Визуализация оптического потока (стрелки/HSV/heatmap).
2. **Поверх фона:**
   - **Зеленые стрелки** (если используется Хорн-Шанк) — векторы плотного потока в местах движения.
     - Каждая стрелка: от точки A до точки B, показывает направление и скорость движения.
     - Рисуются на сетке с шагом 20 пикселей.
     - Отображаются только там, где magnitude > 1.0 (есть движение).
   - **Цветные прямоугольники** — bounding box'ы машин.
   - **ID** — уникальный номер каждой машины (например, "ID 3").
   - **Траектория** — цветная линия, показывающая путь машины за последние 30 кадров.
   - **Центроид** — маленький кружок в центре каждого объекта.

---

## 6. Почему это работает "как надо"

1. **Использование реализованных алгоритмов:** Мы используем Хорн-Шанк и Лукас-Канаде из `core/`, а не сторонние библиотеки.
2. **Адаптивный порог:** Метод Otsu автоматически подстраивается под освещение и контраст видео.
3. **Умная морфология:** Последовательность операций (closing → opening → dilation) оптимизирована для объединения частей машин.
4. **Устойчивость к цвету:** Поток работает на градиентах, а не на цвете. Серая машина на сером асфальте будет замечена.
5. **Гибкость:** Можно выбрать алгоритм потока в зависимости от задачи (плотный vs. разреженный).
6. **Физичность:** Стрелки показывают реальное физическое движение пикселей.

---

## 7. Типичные проблемы и решения

### Проблема: Машина распадается на несколько объектов

**Причина:** 
- Недостаточная морфология (дыры в маске не заполнены)
- Слишком большой параметр `min_area`

**Решение:**
- Уменьшите `min_area` (например, с 2000 до 800)
- Система уже использует улучшенную морфологию, но если проблема остается:
  - Увеличьте количество итераций Хорна-Шанка (больше итераций = более плотный поток)
  - Уменьшите Lambda (меньше сглаживание = больше деталей)

### Проблема: Не все машины детектируются

**Причина:**
- Машины движутся слишком медленно (малая magnitude)
- Слишком высокий порог Otsu (редко, но бывает на темных видео)

**Решение:**
- Увеличьте количество итераций Хорна-Шанка (до 50-100)
- Уменьшите Lambda (до 0.5)
- Уменьшите `min_area`

### Проблема: Много ложных срабатываний (деревья, тени)

**Причина:**
- Слишком низкий `min_area`
- Ветер создает движение листвы

**Решение:**
- Увеличьте `min_area` (до 1500-2000)
- Система уже использует Opening для удаления мелкого шума

### Проблема: Объекты теряют ID при движении

**Причина:**
- Машина движется слишком быстро (смещение > `max_distance`)
- Машина временно скрывается (за другой машиной)

**Решение:**
- Увеличьте `max_distance` (например, с 50 до 100)
- Увеличьте `max_disappeared` (например, с 40 до 60)

---

## Краткая схема работы

```
[Кадр 1] + [Кадр 2]
    ↓
[Оптический поток: Хорн-Шанк или Лукас-Канаде]
    ↓
[Поле векторов (u, v) или Точки + Векторы]
    ↓
[Если "Отслеживание" включено:]
    ↓
[Создание маски движения]
    ↓
[Морфология (чистка)]
    ↓
[Поиск контуров → Прямоугольники]
    ↓
[Центроидный трекер → Присвоение ID]
    ↓
[Визуализация: Поток + Bounding Boxes + Траектории]
```

---

**Итого:**
Система гибкая, модульная и использует ваши собственные реализации алгоритмов оптического потока для детектирования и отслеживания движущихся объектов.
