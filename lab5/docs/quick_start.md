# Быстрый старт: Отслеживание объектов

## Запуск приложения

```bash
python main.py
```

## Сценарий 1: Просто визуализация оптического потока

1. Загрузите видео (кнопка "Загрузить видео")
2. Выберите алгоритм:
   - **Хорн-Шанк** — для плотного потока (каждый пиксель)
   - **Лукас-Канаде** — для разреженного потока (ключевые точки)
3. Настройте параметры алгоритма через слайдеры
4. Нажмите "Обработать кадр"
5. Выберите режим визуализации:
   - **HSV** — цветная карта (для Хорна-Шанка)
   - **Стрелки** — векторы на сетке
   - **Heat Map** — тепловая карта

**Результат:** Вы увидите визуализацию движения в кадре.

---

## Сценарий 2: Отслеживание машин (или других объектов)

1. Загрузите видео с трафиком
2. Выберите алгоритм (рекомендуется **Хорн-Шанк** для лучшего качества)
3. **Поставьте галочку "Включить отслеживание"**
4. Настройте параметры трекинга:
   - **Мин. площадь**: 500-2000 (зависит от размера объектов в кадре)
   - **Макс. исчезновение**: 40 (сколько кадров объект может быть скрыт)
   - **Макс. дистанция**: 50 (насколько далеко объект может сдвинуться между кадрами)
5. Нажмите "Обработать кадр"

**Результат:** 
- Цветные прямоугольники вокруг машин
- Уникальные ID для каждой машины
- Траектории движения (цветные линии)
- Зеленые штрихи плотного потока (если выбран Хорн-Шанк)

---

## Настройка параметров для лучшего результата

### Параметры Хорна-Шанка

- **Lambda (λ)**: 0.5-2.0
  - Меньше → более точный, но менее гладкий поток
  - Больше → более гладкий, но менее точный
  - **Рекомендуется**: 1.0

- **Итерации**: 30-100
  - Меньше → быстрее, но менее точно
  - Больше → медленнее, но точнее
  - **Рекомендуется**: 30 (для реального времени), 100 (для качества)

### Параметры Лукаса-Канаде

- **Размер окна**: 15-31 (нечетное)
  - Меньше → точнее для мелких деталей
  - Больше → устойчивее к шуму
  - **Рекомендуется**: 15

- **Уровни пирамиды**: 2-3
  - Больше → лучше для быстрых движений
  - **Рекомендуется**: 2

- **Макс. углов**: 500-1000
  - Больше → больше точек отслеживания
  - **Рекомендуется**: 500

### Параметры трекинга

- **Мин. площадь**:
  - Видео 1920x1080: 1000-2000
  - Видео 640x480: 300-500
  - Правило: Если много ложных срабатываний (мелкие объекты) — увеличьте

- **Макс. исчезновение**:
  - Медленное видео (< 15 FPS): 20-30
  - Быстрое видео (> 30 FPS): 40-60
  - Правило: Если объекты теряют ID при временном скрытии — увеличьте

- **Макс. дистанция**:
  - Медленное движение: 30-50
  - Быстрое движение: 50-100
  - Правило: Если объекты теряют ID при быстром движении — увеличьте

---

## Типичные проблемы и решения

### Проблема: Машина распадается на несколько объектов (капот, крыша, багажник отдельно)

**Решение:**
- **Уменьшите "Мин. площадь"** (например, с 1500 до 500-800)
  - Это позволит системе захватить все части машины
- **Увеличьте количество итераций Хорна-Шанка** (до 50-100)
  - Больше итераций = более плотный поток = меньше дыр в маске
- **Уменьшите Lambda** (до 0.5-0.7)
  - Меньше сглаживание = больше деталей потока
- **Примечание**: Система уже использует улучшенную морфологию (closing → opening → dilation), которая автоматически объединяет близкие части

### Проблема: Не все машины детектируются

**Решение:**
- **Увеличьте количество итераций Хорна-Шанка** (до 50-100)
  - Медленно движущиеся машины требуют больше итераций для детекции
- **Уменьшите Lambda** (до 0.5)
  - Меньше сглаживание = более чувствительная детекция
- **Уменьшите "Мин. площадь"** (до 300-500)
  - Для детекции более мелких или далеких машин
- **Проверьте освещение**: На темных видео порог Otsu может быть слишком высоким

### Проблема: Слишком много ложных срабатываний (деревья, тени, шум)

**Решение:**
- **Увеличьте "Мин. площадь"** (например, с 500 до 1500-2000)
  - Фильтрует мелкие объекты (листва, тени)
- **Для Хорна-Шанка: увеличьте Lambda** (до 1.5-2.0)
  - Больше сглаживание = меньше шума
- **Примечание**: Система уже использует Opening для удаления мелкого шума

### Проблема: Объекты теряют ID при движении

**Решение:**
- **Увеличьте "Макс. дистанция"** (например, с 50 до 80-100)
  - Для быстро движущихся машин
- **Увеличьте "Макс. исчезновение"** (например, с 40 до 60)
  - Для машин, которые временно скрываются за другими объектами

### Проблема: Медленная обработка

**Решение:**
- **Для Хорна-Шанка: уменьшите количество итераций** (до 20-30)
  - Компромисс между скоростью и качеством
- **Используйте Лукас-Канаде** вместо Хорна-Шанка
  - Быстрее, но менее точно для трекинга
- **Уменьшите количество углов для Лукаса-Канаде** (до 200-300)

### Проблема: Стрелки потока не видны или их слишком много

**Решение:**
- Стрелки рисуются только там, где magnitude > 1.0
- Если их не видно: уменьшите Lambda (больше деталей потока)
- Если их слишком много: увеличьте Lambda (сглаживание)
- Стрелки рисуются на сетке с шагом 20 пикселей (это нормально)

---

## Экспорт результатов

1. После обработки нажмите "Экспорт отчёта"
2. Отчёт сохранится в папке `reports/`
3. Формат: JSON с метаданными, параметрами и результатами

---

## Горячие клавиши (если реализованы)

- **Пробел**: Пауза/Воспроизведение
- **Стрелка вправо**: Следующий кадр
- **Стрелка влево**: Предыдущий кадр

---

## Рекомендуемые настройки для разных задач

### Задача: Подсчет машин на дороге

- Алгоритм: **Хорн-Шанк**
- Отслеживание: **Включено**
- Lambda: 1.0
- Итерации: 50
- Мин. площадь: 1500
- Макс. исчезновение: 50
- Макс. дистанция: 70

### Задача: Анализ траекторий пешеходов

- Алгоритм: **Лукас-Канаде**
- Отслеживание: **Включено**
- Размер окна: 21
- Уровни пирамиды: 3
- Мин. площадь: 300
- Макс. исчезновение: 30
- Макс. дистанция: 40

### Задача: Визуализация потока для презентации

- Алгоритм: **Хорн-Шанк**
- Отслеживание: **Выключено**
- Lambda: 1.5 (гладкий поток)
- Итерации: 100
- Визуализация: **HSV** или **Heat Map**
