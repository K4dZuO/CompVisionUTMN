# Ключевые улучшения детекции объектов

## Проблема: Машины распадались на части

### Было (старая версия):
```python
# Фиксированный порог
_, mask = cv2.threshold(magnitude, 1.5, 255, cv2.THRESH_BINARY)

# Простая морфология
kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
mask = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel)
mask = cv2.morphologyEx(mask, cv2.MORPH_DILATE, kernel, iterations=2)
```

**Результат**: Машина детектировалась как 3-5 отдельных объектов (капот, крыша, багажник, колеса).

### Стало (новая версия):
```python
# 1. Нормализация для стабильности
magnitude_norm = cv2.normalize(magnitude, None, 0, 255, cv2.NORM_MINMAX)

# 2. Адаптивный порог (Otsu)
_, mask = cv2.threshold(magnitude_norm.astype(np.uint8), 0, 255, 
                       cv2.THRESH_BINARY + cv2.THRESH_OTSU)

# 3. Улучшенная морфология (3 этапа)
# Этап 1: Closing (7x7) - заполняет дыры (лобовое стекло, окна)
kernel_close = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (7, 7))
mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel_close)

# Этап 2: Opening (3x3) - убирает мелкий шум
kernel_open = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
mask = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel_open)

# Этап 3: Dilation (5x5, 2 итерации) - объединяет близкие части
kernel_dilate = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (5, 5))
mask = cv2.morphologyEx(mask, cv2.MORPH_DILATE, kernel_dilate, iterations=2)
```

**Результат**: Машина детектируется как 1 цельный объект.

---

## Почему это работает лучше?

### 1. Адаптивный порог (Otsu)

**Проблема фиксированного порога:**
- Видео 1: Яркий день, высокий контраст → порог 1.5 слишком низкий → много шума
- Видео 2: Пасмурно, низкий контраст → порог 1.5 слишком высокий → машины не детектируются

**Решение Otsu:**
- Автоматически анализирует гистограмму magnitude
- Находит оптимальный порог для разделения "фон" vs "движение"
- Адаптируется к каждому видео

### 2. Closing (Закрытие) - Первый этап

**Что делает:**
- Сначала расширяет (dilate), потом сужает (erode)
- Заполняет дыры внутри белых пятен

**Зачем:**
- Лобовое стекло машины прозрачное → не дает потока → дыра в маске
- Окна машины → дыры в маске
- Closing заполняет эти дыры, превращая машину в цельное пятно

**Размер ядра 7x7:**
- Достаточно большое, чтобы заполнить окна и стекла
- Не слишком большое, чтобы не объединить разные машины

### 3. Opening (Открытие) - Второй этап

**Что делает:**
- Сначала сужает (erode), потом расширяет (dilate)
- Убирает мелкие белые пятна

**Зачем:**
- Листва на ветру → мелкие белые пятна
- Дрожание камеры → шум
- Opening убирает эти ложные срабатывания

**Размер ядра 3x3:**
- Маленькое ядро, чтобы не удалить реальные мелкие объекты (мотоциклы, велосипеды)

### 4. Dilation (Расширение) - Третий этап

**Что делает:**
- Расширяет белые пятна

**Зачем:**
- Капот, крыша, багажник машины могут быть разделены небольшими промежутками
- Dilation "раздувает" эти части, чтобы они соприкоснулись и объединились

**Размер ядра 5x5, 2 итерации:**
- 2 итерации = расширение на ~10 пикселей в каждую сторону
- Достаточно, чтобы объединить части машины
- Не слишком много, чтобы не объединить разные машины

---

## Визуальная схема

```
Исходная маска (после порога Otsu):
┌─────────────────────────┐
│  ███     ███     ███    │  ← Капот, крыша, багажник (разделены)
│  ███     ███     ███    │
└─────────────────────────┘

После Closing (7x7):
┌─────────────────────────┐
│  ███████████████████    │  ← Дыры заполнены
│  ███████████████████    │
└─────────────────────────┘

После Opening (3x3):
┌─────────────────────────┐
│  ███████████████████    │  ← Шум убран (если был)
│  ███████████████████    │
└─────────────────────────┘

После Dilation (5x5, x2):
┌─────────────────────────┐
│ █████████████████████   │  ← Объект расширен, части объединены
│ █████████████████████   │
└─────────────────────────┘
```

---

## Сравнение результатов

### Старая версия (фиксированный порог + простая морфология):
- ✅ Быстро (меньше операций)
- ❌ Машина = 3-5 объектов
- ❌ Не адаптируется к разным видео
- ❌ Много ложных срабатываний

### Новая версия (Otsu + улучшенная морфология):
- ✅ Машина = 1 объект
- ✅ Адаптируется к освещению
- ✅ Меньше ложных срабатываний
- ✅ Заполняет дыры (стекла, окна)
- ⚠️ Немного медленнее (3 этапа морфологии вместо 2)

---

## Рекомендуемые параметры

### Для видео с трафиком (1920x1080):
- **Мин. площадь**: 800-1200 (после морфологии объекты стали больше)
- **Итерации Хорна-Шанка**: 50-100 (для плотного потока)
- **Lambda**: 0.7-1.0 (компромисс детали/сглаживание)

### Для видео с трафиком (640x480):
- **Мин. площадь**: 300-500
- **Итерации Хорна-Шанка**: 30-50
- **Lambda**: 0.5-0.7

---

## Когда может не работать

1. **Очень быстрое движение**: Хорн-Шанк с 30 итерациями может не успеть
   - Решение: Увеличить итерации до 100 или использовать Farneback (OpenCV)

2. **Очень медленное движение**: Magnitude слишком мала
   - Решение: Уменьшить Lambda (меньше сглаживание)

3. **Плохое освещение**: Низкий контраст
   - Решение: Предобработка видео (увеличение контраста)

4. **Статичная камера + статичные машины**: Нет потока
   - Это нормально: система отслеживает только движущиеся объекты
