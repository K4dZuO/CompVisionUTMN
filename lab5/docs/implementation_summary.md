# Сводка реализации отслеживания объектов

## Что было сделано

### 1. Архитектура системы

Реализована модульная система, состоящая из двух независимых компонентов:

- **Модуль оптического потока** (Хорн-Шанк / Лукас-Канаде)
- **Модуль отслеживания объектов** (опциональный, включается чекбоксом)

### 2. Новые файлы

#### `core/object_tracker.py`
- **CentroidTracker**: Класс для отслеживания объектов по центроидам
  - Регистрация новых объектов
  - Деregистрация исчезнувших объектов
  - Сопоставление объектов между кадрами по Евклидову расстоянию
  - Хранение траекторий (последние 30 точек)

- **ObjectTracker**: Основной класс трекера
  - `process_frame()`: Обработка с использованием background subtraction (MOG2)
  - `update_from_mask()`: Обновление трекера на основе бинарной маски движения
  - Интеграция с HornSchunckProcessor для вычисления плотного потока

#### `docs/tracking_explanation.md`
Подробное объяснение работы системы отслеживания "на пальцах":
- Как работает плотный поток (Хорн-Шанк)
- Как работает разреженный поток (Лукас-Канаде)
- Процесс создания маски движения
- Алгоритм центроидного трекинга
- Визуализация результатов

#### `docs/quick_start.md`
Практическое руководство по использованию:
- Сценарии использования
- Рекомендуемые настройки параметров
- Решение типичных проблем
- Примеры для разных задач

### 3. Изменения в существующих файлах

#### `gui/controls.py`
- Добавлен чекбокс "Включить отслеживание" в `AlgorithmParametersWidget`
- Добавлены слайдеры для параметров трекинга:
  - Мин. площадь (100-5000)
  - Макс. исчезновение (1-100 кадров)
  - Макс. дистанция (10-200 пикселей)
- Метод `get_tracker_params()` возвращает параметры трекинга

#### `gui/main_window.py`
- **ProcessingThread** обновлен для поддержки комбинированного режима:
  - Вычисляет оптический поток (Хорн-Шанк или Лукас-Канаде)
  - Если трекинг включен, создает маску из потока
  - Обновляет трекер на основе маски
  - Возвращает комбинированные результаты (поток + трекинг)

- **OpticalFlowMainWindow**:
  - Удален отдельный режим "Отслеживание объектов" из выпадающего списка
  - Трекинг теперь опция, которая накладывается поверх любого алгоритма потока
  - `process_current_frame()` передает параметры трекинга в поток обработки
  - `update_visualization()` накладывает результаты трекинга поверх визуализации потока

#### `utils/visualization.py`
- `visualize_tracked_objects()` обновлен для отрисовки:
  - Зеленых штрихов плотного потока (если есть u, v)
  - Bounding box'ов вокруг объектов
  - Уникальных ID для каждого объекта
  - Траекторий движения (цветные линии)
  - Центроидов объектов

#### `core/video_processor.py`
- Добавлен импорт `deque` из `collections` (исправление бага)

#### `README.md`
- Обновлен раздел "Особенности" с упоминанием отслеживания
- Добавлен раздел "Режимы работы"
- Обновлены инструкции по использованию
- Добавлена информация о параметрах трекинга

### 4. Тесты

#### `tests/test_tracker.py`
- Тесты для `CentroidTracker`:
  - `test_tracking_movement`: Проверка отслеживания движущихся объектов
  - `test_tracking_disappearance`: Проверка обработки исчезающих объектов
  - `test_multiple_objects`: Проверка отслеживания нескольких объектов одновременно
  - `test_max_distance`: Проверка параметра максимальной дистанции

- Все тесты успешно проходят (4/4)

## Как это работает

### Режим 1: Только оптический поток

```
[Кадр 1] + [Кадр 2]
    ↓
[Хорн-Шанк или Лукас-Канаде]
    ↓
[Визуализация: HSV / Стрелки / Heat Map]
```

### Режим 2: Оптический поток + Отслеживание

```
[Кадр 1] + [Кадр 2]
    ↓
[Хорн-Шанк или Лукас-Канаде]
    ↓
[Поле векторов (u, v) или Точки]
    ↓
[Создание маски движения]
    ↓
[Морфология (чистка шума)]
    ↓
[Поиск контуров → Bounding Boxes]
    ↓
[Центроидный трекер → Присвоение ID]
    ↓
[Визуализация: Поток + Boxes + Траектории]
```

## Ключевые особенности реализации

### 1. Использование собственных алгоритмов
- Используется `HornSchunckProcessor` из `core/horn_schunck.py`
- Используется `LucasKanadeProcessor` из `core/lucas_kanade.py`
- Не используются сторонние библиотеки для вычисления потока (кроме OpenCV для базовых операций)

### 2. Модульность
- Трекинг полностью независим от алгоритма потока
- Можно использовать любой алгоритм потока для детекции движения
- Легко добавить новые алгоритмы потока

### 3. Гибкость
- Все параметры настраиваются через GUI
- Можно включать/выключать трекинг без перезапуска
- Поддержка разных режимов визуализации

### 4. Производительность
- Обработка в отдельном потоке (не блокирует GUI)
- Для Хорна-Шанка используется 30 итераций (компромисс скорость/качество)
- Морфологические операции оптимизированы

## Параметры по умолчанию

### Хорн-Шанк
- Lambda: 1.0
- Итерации: 30 (для трекинга), 100 (для визуализации)
- Threshold: 0.001

### Лукас-Канаде
- Размер окна: 15
- Уровни пирамиды: 2
- Макс. углов: 500

### Трекинг
- Мин. площадь: 500 пикселей
- Макс. исчезновение: 40 кадров
- Макс. дистанция: 50 пикселей
- Макс. длина траектории: 30 точек

## Известные ограничения

1. **Скорость Хорна-Шанка**: Чистая Python реализация медленнее оптимизированного OpenCV Farneback
2. **Трекинг Лукаса-Канаде**: Маска создается из разреженных точек, может быть менее точной для плотных объектов
3. **Статичные объекты**: Трекер не отслеживает неподвижные объекты (это фича, не баг)

## Возможные улучшения

1. **Оптимизация**: Использовать Numba/Cython для ускорения Хорна-Шанка
2. **Дополнительные алгоритмы**: Добавить Farneback как опцию
3. **Классификация объектов**: Интеграция YOLO/SSD для определения типа объекта
4. **Калман-фильтр**: Улучшение предсказания позиции объектов
5. **Экспорт траекторий**: Сохранение траекторий в CSV/JSON

## Зависимости

- Python 3.8+
- OpenCV 4.5.0+
- PyQt5 5.15.0+
- NumPy 1.21.0+
- Matplotlib 3.5.0+ (для визуализации)
- SciPy 1.7.0+ (для вычислений)

## Заключение

Реализована полнофункциональная система отслеживания объектов, которая:
- ✅ Использует собственные реализации алгоритмов оптического потока
- ✅ Поддерживает оба алгоритма (Хорн-Шанк и Лукас-Канаде)
- ✅ Визуализирует плотный поток штрихами
- ✅ Отслеживает объекты через несколько кадров
- ✅ Присваивает уникальные ID объектам
- ✅ Отображает траектории движения
- ✅ Имеет гибкие настройки параметров
- ✅ Покрыта unit-тестами
- ✅ Документирована

Система готова к использованию для анализа видео с трафиком и других задач отслеживания движущихся объектов.
